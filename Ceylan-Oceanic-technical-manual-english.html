<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<title>Welcome to the Ceylan-Oceanic documentation</title>
<meta content="Oceanic, Enocean, home automation, Erlang" name="keywords" />
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="oceanic.css" type="text/css" />
<link href="oceanic-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document" id="ceylan-oceanic-enocean-facilities-in-erlang">
<h1 class="title">Ceylan-Oceanic: Enocean facilities in Erlang</h1>

<span class="target" id="top"></span><p><span class="raw-html"><a name="oceanic_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Oceanic documentation</em> <a href="http://oceanic.esperide.org">browse latest</a> <a href="https://olivier-boudeville.github.io/Ceylan-Oceanic/index.html">browse mirror</a> <a href="Ceylan-Oceanic-technical-manual-english.pdf">get PDF</a> <a href="#oceanic_top">go to top</a> <a href="#oceanic_toc">go to toc</a> <a href="#oceanic_bottom">go to bottom</a> <a href="api-doc/index.html">browse API</a> <a href="https://github.com/Olivier-Boudeville/Ceylan-Oceanic">go to project</a> <a href="mailto:about(dash)oceanic(at)esperide(dot)com?subject=[Ceylan-Oceanic]%20Remark">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="oceanic-title.png" id="responsive-image-small"></img></span>
</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body">Copyright (C) 2022-2022 Olivier Boudeville</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body">about (dash) oceanic (at) esperide (dot) com</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body">Wednesday, September 7, 2022</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body">Sunday, November 6, 2022</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">0.0.1</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">In development</td>
</tr>
<tr class="field"><th class="field-name">Dedication:</th><td class="field-body">Users and maintainers of the <tt class="docutils literal"><span class="pre">Ceylan-Oceanic</span></tt> library.</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body">The role of the <tt class="docutils literal"><span class="pre">Ceylan-Oceanic</span></tt> library is to provide Erlang-based facilities for the support of the Enocean building automation system.</td>
</tr>
</tbody>
</table>
<p><span class="raw-html"></center></span></p>
<p>The latest version of this documentation is to be found at the <a class="reference external" href="http://oceanic.esperide.org">official Ceylan-Oceanic website</a> (<tt class="docutils literal"><span class="pre">http://oceanic.esperide.org</span></tt>).</p>
<p><span class="raw-html">This Ceylan-Oceanic documentation is also available in the PDF format (see <a href="Ceylan-Oceanic-technical-manual-english.pdf">Ceylan-Oceanic-technical-manual-english.pdf</a>), and mirrored <a href="http://olivier-boudeville.github.io/Ceylan-Oceanic/">here</a>.</span></p>
<p></p>
<p></p>
<p><span class="raw-html"><a name="oceanic_toc"></a></span></p>
<div class="contents topic" id="topic-1">
<span id="table-of-contents"></span><p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="toc-entry-1">Overview</a></li>
<li><a class="reference internal" href="#purpose" id="toc-entry-2">Purpose</a></li>
<li><a class="reference internal" href="#progress-enocean-coverage" id="toc-entry-3">Progress &amp; Enocean Coverage</a></li>
<li><a class="reference internal" href="#testing-ceylan-oceanic-in-two-steps" id="toc-entry-4">Testing Ceylan-Oceanic in Two Steps</a></li>
<li><a class="reference internal" href="#hardware-prerequisites" id="toc-entry-5">Hardware Prerequisites</a></li>
<li><a class="reference internal" href="#operating-system-support" id="toc-entry-6">Operating System Support</a></li>
<li><a class="reference internal" href="#software-prerequisites" id="toc-entry-7">Software Prerequisites</a></li>
<li><a class="reference internal" href="#testing" id="toc-entry-8">Testing</a><ul>
<li><a class="reference internal" href="#basic-direct-testing" id="toc-entry-9">Basic, Direct Testing</a></li>
<li><a class="reference internal" href="#oceanic-testing" id="toc-entry-10">Oceanic Testing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#enocean-documentation" id="toc-entry-11">Enocean Documentation</a></li>
<li><a class="reference internal" href="#support" id="toc-entry-12">Support</a></li>
<li><a class="reference internal" href="#additional-information" id="toc-entry-13">Additional Information</a></li>
<li><a class="reference internal" href="#related-projects" id="toc-entry-14">Related Projects</a></li>
<li><a class="reference internal" href="#please-react" id="toc-entry-15">Please React!</a></li>
<li><a class="reference internal" href="#ending-word" id="toc-entry-16">Ending Word</a></li>
</ul>
</div>
<p></p>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#toc-entry-1">Overview</a></h1>
<p>The Ceylan-Oceanic library provides <a class="reference external" href="http://erlang.org">Erlang</a>-based facilities for the support of the <a class="reference external" href="https://en.wikipedia.org/wiki/EnOcean">Enocean</a> building automation system, whose devices are generally energy-harvesting/very low-consumption and wireless (generally around 900 MHz, depending on countries; for a range of up to 300 meters in the open, and up to 30 meters inside buildings).</p>
<p>Besides Erlang, Ceylan-Oceanic relies only on <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad">Ceykan-Myriad</a> and is a rather autonomous part of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan">Ceylan</a> project. Ceylan-Oceanic can be readily built and run on most Unices, including of course GNU/Linux.</p>
<p>The project repository is located <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Oceanic">here</a>.</p>
<p>At least a basic knowledge of Erlang is expected in order to use Ceylan-Oceanic.</p>
</div>
<div class="section" id="purpose">
<h1><a class="toc-backref" href="#toc-entry-2">Purpose</a></h1>
<p>The main motivation of Oceanic is to provide some basic home automation features, especially in terms of security, in order to be able to:</p>
<ul class="simple">
<li><strong>intercept and decode telegrams</strong> emitted by sensors, notably single-input contacts (to detect the opening/closing of doors or windows), temperature/humidity sensors or to detect electricity outages</li>
<li><strong>generate and emit telegrams</strong> to control various electrical devices (e.g. lamps), typically for a presence simulator, to turn on an electric heater</li>
</ul>
</div>
<div class="section" id="progress-enocean-coverage">
<h1><a class="toc-backref" href="#toc-entry-3">Progress &amp; Enocean Coverage</a></h1>
<p>The targeted basic Enocean support has been implemented, so EEP Enocean telegrams can be intercepted and, for the supported EEPs (others may be quite easily added), such telegrams can be properly decoded, as incoming higher-level events.</p>
<p>Reciprocally, telegrams for the supported EEPs can also be encoded and sent.</p>
<p>Yet, for some reason (still unknown), currently our target device (a smart plug) does not seem to accept them (no reaction).</p>
<p>This problem does not seem specific to Oceanic, insofar as recording directly from the command-line an accepted telegram from the USB gateway and sending it exactly as it was (replay) has no effect either on said device - whereas no anti-replay mechanism seems to be enforced here. Investigations are in progress.</p>
<p>Oceanic can also execute a few common commands directly onto the gateway chip.</p>
</div>
<div class="section" id="testing-ceylan-oceanic-in-two-steps">
<h1><a class="toc-backref" href="#toc-entry-4">Testing Ceylan-Oceanic in Two Steps</a></h1>
<p>Now, let's discuss these subjects a bit more in-depth.</p>
</div>
<div class="section" id="hardware-prerequisites">
<h1><a class="toc-backref" href="#toc-entry-5">Hardware Prerequisites</a></h1>
<p>In terms of Enocean devices, one needs typically:</p>
<ul class="simple">
<li>any kind of emitter/sensor, for example a single-input contact/rocker button like <a class="reference external" href="https://www.enocean.com/en/product-category/kinetic-switches-finished-products/?frequency=902">these ones</a></li>
<li>a receiver, typically a USB gateway, which includes a <a class="reference external" href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter">UART</a> for asynchronous serial communication with an integrated RF module</li>
</ul>
<p>Popular USB dongles, which often relies on the <a class="reference external" href="https://www.enocean.com/wp-content/uploads/downloads-produkte/en/products/enocean_modules/tcm-310/user-manual-pdf/TCM310_UserManual_Oct2019.pdf">TCM 310 chip</a>, include the <a class="reference external" href="https://www.enocean.com/en/product/usb-300-500u-400j/">USB300</a> one (around 37 Euros in France), or the USB310 one (around 50 Euros in France) that we prefer as it features a <a class="reference external" href="https://en.wikipedia.org/wiki/SMA_connector">SMA connector</a>, which allows an external antenna to be connected in order to boost emission/reception ranges.</p>
<p>We will rely here on such a configuration.</p>
</div>
<div class="section" id="operating-system-support">
<h1><a class="toc-backref" href="#toc-entry-6">Operating System Support</a></h1>
<p>Once the USB dongle is connected (here on an Arch Linux box), <tt class="docutils literal">lsusb</tt> tells us that it is detected as:</p>
<pre class="code literal-block">
Bus 003 Device 009: ID 0403:6001 Future Technology Devices International, Ltd FT232 Serial (UART) IC
</pre>
<p>(which applies both to USB300 and USB310)</p>
<p>We will interact with this USB gateway as if it was a serial port.</p>
<p>Rather than having it designated by an obscure, potentially changing name (like <tt class="docutils literal">/dev/ttyUSB0</tt>, <tt class="docutils literal">/dev/ttyUSB1</tt>, etc.), we prefer assigning it a fixed, well-chosen path, like <tt class="docutils literal">/dev/ttyUSBEnOcean</tt>.</p>
<p>For that, one may define a suitable udev rule, typically stored in <tt class="docutils literal"><span class="pre">/etc/udev/rules.d/99-enocean.rules</span></tt>, whose content can simply be:</p>
<pre class="code literal-block">
SUBSYSTEM==&quot;tty&quot;, ATTRS{idVendor}==&quot;0403&quot;, ATTRS{idProduct}==&quot;6001&quot;, SYMLINK+=&quot;ttyUSBEnOcean&quot;, MODE==&quot;0666&quot;
</pre>
<p>Following option could be added as well, to set the group of this TTY: <tt class="docutils literal"><span class="pre">GROUP=&quot;dialout&quot;</span></tt> ou <tt class="docutils literal"><span class="pre">GROUP=&quot;uucp&quot;</span></tt>, in which case your user shall be in that group (rather than running <tt class="docutils literal">sudo chmod 777 /dev/ttyUSB0</tt> each time the device is inserted for example).</p>
<p>One may run <tt class="docutils literal">sudo udevadm control <span class="pre">--reload-rules</span> &amp;&amp; sudo udevadm trigger</tt> to ensure that these changes are taken into account.</p>
<p>Then inserting said dongle should generate log entries that <tt class="docutils literal">journalctl <span class="pre">-xe</span></tt> can show, like (timestamps and hostname edited):</p>
<pre class="code literal-block">
kernel: usb 3-11: new full-speed USB device number 9 using xhci_hcd
kernel: usb 3-11: New USB device found, idVendor=0403, idProduct=6001, bcdDevice= 6.00
kernel: usb 3-11: New USB device strings: Mfr=1, Product=2, SerialNumber=3
kernel: usb 3-11: Product: FT232R USB UART
kernel: usb 3-11: Manufacturer: FTDI
kernel: usb 3-11: SerialNumber: A600AVJD
mtp-probe[74533]: checking bus 3, device 9: &quot;/sys/devices/pci0000:00/0000:00:14.0/usb3/3-11&quot;
kernel: ftdi_sio 3-11:1.0: FTDI USB Serial Device converter detected
kernel: usb 3-11: Detected FT232RL
kernel: usb 3-11: FTDI USB Serial Device converter now attached to ttyUSB0
mtp-probe[74533]: bus: 3, device: 9 was not an MTP device
mtp-probe[74548]: checking bus 3, device 9: &quot;/sys/devices/pci0000:00/0000:00:14.0/usb3/3-11&quot;
mtp-probe[74548]: bus: 3, device: 9 was not an MTP device
</pre>
<p>On insertion we have then:</p>
<pre class="literal-block">
.. code:: bash
</pre>
<blockquote>
$ ls -l /dev/ttyUSBEnOcean /dev/ttyUSB0
FIXME</blockquote>
</div>
<div class="section" id="software-prerequisites">
<h1><a class="toc-backref" href="#toc-entry-7">Software Prerequisites</a></h1>
<p>Ceylan-Oceanic relies on general-purpose services offered by <a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a> (implying of course <a class="reference external" href="https://myriad.esperide.org/#software-prerequisites">Erlang itself</a>), and on an Erlang driver for serial communication.</p>
<p id="erlang-serial">We chose <a class="reference external" href="https://github.com/tonyg/erlang-serial">erlang-serial</a> for that, and we prefer installing it in user space that way:</p>
<pre class="code bash literal-block">
$ mkdir ~/Software <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/Software
$ git clone https://github.com/tonyg/erlang-serial.git
$ <span class="nb">cd</span> erlang-serial
$ make <span class="o">&amp;&amp;</span> <span class="nv">DESTDIR</span><span class="o">=</span>. make install
</pre>
<p>Then using erlang-serial will be just a matter of adding it to the code path.</p>
<p>One may update the <em>Erlang-serial section</em> in Ocenanic's <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Oceanic/blob/main/GNUmakevars.inc">GNUmakevars.inc</a> to take into account any other convention.</p>
<p>One may run, from the root of Oceanic, <tt class="docutils literal">make <span class="pre">info-serial</span></tt> to check that <tt class="docutils literal">ERLANG_SERIAL_BASE</tt> points indeed to a directory containing serial's <tt class="docutils literal">ebin</tt> directory.</p>
<p>To test it (whether or not any dongle is connected):</p>
<pre class="code bash literal-block">
$ erl -pa <span class="nv">$HOME</span>/Software/erlang-serial/erlang/lib/serial-1.1/ebin
Erlang/OTP <span class="m">25</span> <span class="o">[</span>erts-13.0<span class="o">]</span> <span class="o">[</span>source<span class="o">]</span> <span class="o">[</span><span class="m">64</span>-bit<span class="o">]</span> <span class="o">[</span>smp:8:8<span class="o">]</span> <span class="o">[</span>ds:8:8:10<span class="o">]</span> <span class="o">[</span>async-threads:1<span class="o">]</span> <span class="o">[</span>jit:ns<span class="o">]</span>

Eshell V13.0  <span class="o">(</span>abort with ^G<span class="o">)</span>
<span class="m">1</span>&gt; serial:start<span class="o">()</span>.
&lt;<span class="m">0</span>.82.0&gt;
</pre>
<p>Perfect!</p>
</div>
<div class="section" id="testing">
<h1><a class="toc-backref" href="#toc-entry-8">Testing</a></h1>
<div class="section" id="basic-direct-testing">
<h2><a class="toc-backref" href="#toc-entry-9">Basic, Direct Testing</a></h2>
<p>It is as simple as executing from the command-line (thus without Oceanic or Erlang being involved):</p>
<pre class="code bash literal-block">
$ od -x &lt; /dev/ttyUSBEnOcean
<span class="m">0000000</span> <span class="m">0055</span> <span class="m">0707</span> 7a01 10f6 2e00 96e1 <span class="m">0130</span> ffff
<span class="m">0000020</span> ffff <span class="m">0039</span> 554b <span class="m">0700</span> <span class="m">0107</span> f67a <span class="m">0000</span> e12e
</pre>
<p>(of course for such a binary content to be received, Enocean telegrams must be emitted; the simplest approach is to trigger any Enocean device able to send on demand such telegrams, like a button/rocker/switch)</p>
<p><tt class="docutils literal">hexdump</tt> can be also used to intercept telegrams. If needing to set the transmission speed beforehand, use <tt class="docutils literal">stty <span class="pre">-F</span> /dev/ttyUSBEnOcean 57600</tt>.</p>
<p>Incoming data can also be recorded and &quot;replayed&quot; (yet this is not expected to activate an Enocean receiver):</p>
<pre class="code bash literal-block">
$ cat &lt; /dev/ttyUSBEnOcean &gt; my_record.bin
$ cat my_record.bin &gt; /dev/ttyUSBEnOcean
</pre>
</div>
<div class="section" id="oceanic-testing">
<h2><a class="toc-backref" href="#toc-entry-10">Oceanic Testing</a></h2>
<p>From the root of the Ceylan-Oceanic clone, supposing Myriad and erlang-serial are already available and built:</p>
<pre class="code bash literal-block">
<span class="c1"># Ensure that Ceylan-Oceanic is built:
</span>$ make all

$ <span class="nb">cd</span> <span class="nb">test</span>
$ make oceanic_run

       Running unitary <span class="nb">test</span> oceanic_run <span class="o">(</span>third form<span class="o">)</span> from oceanic_test

--&gt; Testing module oceanic_test.

Starting the Enocean <span class="nb">test</span> based on the gateway TTY <span class="s1">'/dev/ttyUSBEnOcean'</span>.
<span class="o">[</span>debug<span class="o">]</span> Using TTY <span class="s1">'/dev/ttyUSBEnOcean'</span> to connect to Enocean gateway, corresponding to serial server &lt;<span class="m">0</span>.84.0&gt;.
<span class="o">[</span>debug<span class="o">]</span> Stopping serial server &lt;<span class="m">0</span>.84.0&gt;.

--&gt; Successful end of test.

<span class="o">(</span><span class="nb">test</span> finished, interpreter halted<span class="o">)</span>
<span class="o">(</span><span class="nb">command</span> success reported<span class="o">)</span>
</pre>
<p></p>
</div>
</div>
<div class="section" id="enocean-documentation">
<h1><a class="toc-backref" href="#toc-entry-11">Enocean Documentation</a></h1>
<ul class="simple">
<li>[ETS]: <a class="reference external" href="https://www.enocean-alliance.org/specifications/">Enocean Technical Specifications</a>, notably for:<ul>
<li>[EEP-gen]: <a class="reference external" href="https://www.enocean-alliance.org/eep/">EnOcean Equipment Profiles</a> (e.g. version 3.1.4, 36 pages), a short, general view onto the structure of the various telegram types that are available (e.g. the RPS one)</li>
<li>[EEP-spec]: <a class="reference external" href="https://www.enocean-alliance.org/wp-content/uploads/2017/05/EnOcean_Equipment_Profiles_EEP_v2.6.7_public.pdf">EEP Specification</a> (e.g. version 2.6.7, 270 pages), for a detailed specification of the various equipment profiles (e.g. <tt class="docutils literal"><span class="pre">F6-01-*</span></tt> being for <em>Switch Buttons</em>)</li>
</ul>
</li>
<li>[ESP3]: <a class="reference external" href="https://www.enocean.com/esp">Enocean Serial Protocol (ESP3) - SPECIFICATION</a> (e.g. version 1.51, 116 pages), a point-to-point packet-based protocol that is lower-level in the network stack; of less interest here)</li>
</ul>
</div>
<div class="section" id="support">
<h1><a class="toc-backref" href="#toc-entry-12">Support</a></h1>
<p>Bugs, questions, remarks, patches, requests for enhancements, etc. are to be reported to the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Oceanic">project interface</a> (typically <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Oceanic/issues">issues</a>) or directly at the email address mentioned at the beginning of this longer document.</p>
</div>
<div class="section" id="additional-information">
<h1><a class="toc-backref" href="#toc-entry-13">Additional Information</a></h1>
<ul class="simple">
<li><a class="reference external" href="http://tvaira.free.fr/projets/activites/enocean.html">EnOcean in Practice</a> (very clear information, in French)</li>
</ul>
</div>
<div class="section" id="related-projects">
<h1><a class="toc-backref" href="#toc-entry-14">Related Projects</a></h1>
<p>They may be used as sources of inspiration:</p>
<ul class="simple">
<li>[PY-EN] the rather complete <a class="reference external" href="https://github.com/kipe/enocean">Python EnOcean</a> library, including for its <a class="reference external" href="https://github.com/kipe/enocean/blob/master/enocean/protocol/EEP.xml">EEP (XML) information</a></li>
</ul>
<ul class="simple">
<li>a Java implementation: <a class="reference external" href="https://github.com/steveohara/enocean4j/tree/master/src/main/java/uk/co/_4ng/enocean/protocol/serial/v3/network/packet">enocean4j</a></li>
<li>the (Java) <a class="reference external" href="https://github.com/fruggy83/openocean">OpenEnocean openHAB binding</a></li>
<li>a first <a class="reference external" href="https://github.com/Cutii/enocean">Rust implementation</a></li>
</ul>
</div>
<div class="section" id="please-react">
<h1><a class="toc-backref" href="#toc-entry-15">Please React!</a></h1>
<p>If you have information more detailed or more recent than those presented in this document, if you noticed errors, neglects or points insufficiently discussed, drop us a line! (for that, follow the <a class="reference internal" href="#support">Support</a> guidelines).</p>
</div>
<div class="section" id="ending-word">
<h1><a class="toc-backref" href="#toc-entry-16">Ending Word</a></h1>
<p>Have fun with Ceylan-Oceanic!</p>
<p><span class="raw-html"><center><img src="oceanic-title.png" id="responsive-image-small"></img></center></span>
</p>
<p><span class="raw-html"><a name="oceanic_bottom"></a></span></p>
</div>
</div>
</body>
</html>
